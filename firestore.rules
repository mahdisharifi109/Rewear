rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // === HELPER FUNCTIONS ===
    
    // Verifica se o utilizador estÃ¡ autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verifica se o utilizador Ã© o dono do recurso
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Valida campos obrigatÃ³rios de produto
    function isValidProduct() {
      let data = request.resource.data;
      return data.name is string && data.name.size() >= 3 && data.name.size() <= 100
        && data.description is string && data.description.size() >= 10 && data.description.size() <= 2000
        && data.price is number && data.price > 0 && data.price <= 10000
        && data.condition in ['Novo', 'Muito bom', 'Bom']
        && data.category in ['Roupa', 'CalÃ§ado', 'Livros', 'EletrÃ³nica', 'Outro']
        && data.imageUrls is list && data.imageUrls.size() > 0 && data.imageUrls.size() <= 10
        && data.quantity is int && data.quantity >= 1 && data.quantity <= 100
        && data.userId is string
        && data.userName is string
        && data.userEmail is string;
    }
    
    // === PRODUCTS ===
    // Produtos pÃºblicos para leitura (marketplace aberto)
    match /products/{productId} {
      // Qualquer pessoa pode ver produtos (nÃ£o requer autenticaÃ§Ã£o)
      allow read: if true;

      // Criar produto: apenas utilizadores autenticados
      // ValidaÃ§Ãµes: todos os campos obrigatÃ³rios + userId do criador
      allow create: if isAuthenticated()
                    && isOwner(request.resource.data.userId)
                    && isValidProduct();

      // Atualizar: apenas o dono do produto
      // Importante: userId nÃ£o pode ser alterado
      allow update: if isAuthenticated()
                    && isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId
                    && isValidProduct();

      // Apagar: apenas o dono do produto
      allow delete: if isOwner(resource.data.userId);
    }
    
    // === USERS ===
    // Perfis de utilizadores: cada um sÃ³ acede aos seus dados
    match /users/{userId} {
      // Ler: apenas o prÃ³prio utilizador
      allow read: if isOwner(userId);
      
      // Criar: apenas na primeira vez (registo)
      allow create: if isOwner(userId)
                    && request.resource.data.username is string
                    && request.resource.data.username.size() >= 3
                    && request.resource.data.username.size() <= 50
                    && request.resource.data.email is string
                    && request.resource.data.favorites is list
                    && request.resource.data.favorites.size() <= 100;  // Limite de favoritos
      
      // Atualizar: apenas o prÃ³prio utilizador
      // NÃ£o permite alterar email (sincronizado com Auth)
      allow update: if isOwner(userId)
                    && request.resource.data.email == resource.data.email
                    && (!request.resource.data.keys().hasAny(['favorites']) 
                        || request.resource.data.favorites.size() <= 100);
    }

    // === REVIEWS ===
    // AvaliaÃ§Ãµes de vendedores: pÃºblicas para leitura
    match /reviews/{reviewId} {
      // Qualquer pessoa pode ler reviews (reputaÃ§Ã£o pÃºblica)
      allow read: if true;
      
      // Criar review: utilizador autenticado + validaÃ§Ãµes
      allow create: if isAuthenticated()
                    && request.resource.data.buyerId == request.auth.uid  // Comprador Ã© o criador
                    && request.resource.data.sellerId is string
                    && request.resource.data.sellerId != request.auth.uid  // NÃ£o pode avaliar a si prÃ³prio
                    && request.resource.data.rating is int
                    && request.resource.data.rating >= 1
                    && request.resource.data.rating <= 5
                    && request.resource.data.comment is string
                    && request.resource.data.comment.size() >= 10
                    && request.resource.data.comment.size() <= 500;
      
      // NÃ£o permite editar ou apagar reviews (integridade do sistema)
      allow update, delete: if false;
    }

    // === SALES ===
    // HistÃ³rico de vendas: apenas vendedor e comprador acedem
    match /sales/{saleId} {
      // Criar: durante checkout (VALIDAÃ‡ÃƒO CRÃTICA DE PREÃ‡O)
      allow create: if isAuthenticated()
                    // 1. Campos obrigatÃ³rios existem
                    && request.resource.data.keys().hasAll(['productId', 'price', 'buyerId', 'sellerId'])
                    // 2. Comprador Ã© o utilizador autenticado
                    && request.resource.data.buyerId == request.auth.uid
                    // 3. PreÃ§o Ã© vÃ¡lido
                    && request.resource.data.price is number
                    && request.resource.data.price > 0
                    // 4. ðŸ”’ CRÃTICO: Valida que o preÃ§o corresponde ao produto real
                    && get(/databases/$(database)/documents/products/$(request.resource.data.productId)).data.price == request.resource.data.price
                    // 5. Produto ainda estÃ¡ disponÃ­vel
                    && get(/databases/$(database)/documents/products/$(request.resource.data.productId)).data.status == 'disponÃ­vel'
                    // 6. Vendedor corresponde ao dono do produto
                    && get(/databases/$(database)/documents/products/$(request.resource.data.productId)).data.userId == request.resource.data.sellerId;
      
      // Ler e atualizar: apenas vendedor ou comprador
      allow read, update: if isAuthenticated()
                          && (request.auth.uid == resource.data.sellerId 
                              || request.auth.uid == resource.data.buyerId);
      
      // NÃ£o permite apagar vendas (histÃ³rico permanente)
      allow delete: if false;
    }

    // === PURCHASES ===
    // HistÃ³rico de compras: apenas comprador e vendedor acedem
    match /purchases/{purchaseId} {
      // Criar: durante checkout (VALIDAÃ‡ÃƒO CRÃTICA DE PREÃ‡O)
      allow create: if isAuthenticated()
                    // 1. Campos obrigatÃ³rios existem
                    && request.resource.data.keys().hasAll(['productId', 'price', 'buyerId', 'sellerId'])
                    // 2. Comprador Ã© o utilizador autenticado
                    && request.resource.data.buyerId == request.auth.uid
                    // 3. PreÃ§o Ã© vÃ¡lido
                    && request.resource.data.price is number
                    && request.resource.data.price > 0
                    // 4. ðŸ”’ CRÃTICO: Valida que o preÃ§o corresponde ao produto real
                    && get(/databases/$(database)/documents/products/$(request.resource.data.productId)).data.price == request.resource.data.price
                    // 5. Produto ainda estÃ¡ disponÃ­vel
                    && get(/databases/$(database)/documents/products/$(request.resource.data.productId)).data.status == 'disponÃ­vel'
                    // 6. Vendedor corresponde ao dono do produto
                    && get(/databases/$(database)/documents/products/$(request.resource.data.productId)).data.userId == request.resource.data.sellerId;
      
      // Ler e atualizar: apenas comprador ou vendedor
      allow read, update: if isAuthenticated()
                          && (request.auth.uid == resource.data.sellerId 
                              || request.auth.uid == resource.data.buyerId);
      
      // NÃ£o permite apagar compras (histÃ³rico permanente)
      allow delete: if false;
    }
    

    // === NOTIFICATIONS ===
    // NotificaÃ§Ãµes: cada utilizador sÃ³ vÃª as suas
    match /notifications/{notificationId} {
      // Ler e marcar como lida: apenas o destinatÃ¡rio
      allow read, update: if isAuthenticated() 
                          && request.auth.uid == resource.data.userId;
      
      // Criar: sistema/Cloud Functions (permitir com validaÃ§Ã£o bÃ¡sica)
      allow create: if isAuthenticated()
                    && request.resource.data.userId is string
                    && request.resource.data.read == false;
      
      // Apagar: apenas o destinatÃ¡rio
      allow delete: if isOwner(resource.data.userId);
    }

    // === CONVERSATIONS ===
    // Conversas privadas: apenas participantes acedem
    match /conversations/{conversationId} {
      // Ler e atualizar: apenas se for participante
      allow read, update: if isAuthenticated() 
                          && request.auth.uid in resource.data.participantIds;
      
      // Criar: se o criador estÃ¡ nos participantes
      allow create: if isAuthenticated()
                    && request.auth.uid in request.resource.data.participantIds
                    && request.resource.data.participantIds is list
                    && request.resource.data.participantIds.size() == 2;  // Conversas 1-para-1
      
      // NÃ£o permite apagar conversas
      allow delete: if false;
    }

    // === MESSAGES (subcoleÃ§Ã£o de conversations) ===
    match /conversations/{conversationId}/messages/{messageId} {
      // Ler: apenas participantes da conversa
      allow read: if isAuthenticated()
                  && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
      
      // Criar: remetente tem de ser o utilizador autenticado
      allow create: if isAuthenticated()
                    && request.auth.uid == request.resource.data.senderId
                    && request.resource.data.text is string
                    && request.resource.data.text.size() > 0
                    && request.resource.data.text.size() <= 1000;  // Limite de caracteres
      
      // NÃ£o permite editar ou apagar mensagens
      allow update, delete: if false;
    }

    // === WALLET TRANSACTIONS ===
    // TransaÃ§Ãµes da carteira: histÃ³rico financeiro privado
    match /wallet_transactions/{transactionId} {
      // Ler: apenas o dono das transaÃ§Ãµes
      allow read: if isOwner(resource.data.userId);
      
      // Criar: durante checkout/vendas (validaÃ§Ã£o bÃ¡sica)
      allow create: if isAuthenticated()
                    && request.resource.data.userId is string
                    && request.resource.data.type in ['venda', 'compra', 'levantamento', 'ajuste', 'taxa', 'bonus']
                    && request.resource.data.amount is number
                    && request.resource.data.description is string;
      
      // NÃ£o permite editar transaÃ§Ãµes (histÃ³rico imutÃ¡vel)
      allow update: if false;
      
      // Apagar: apenas admin (future feature)
      allow delete: if false;
    }
  }
}